## 转移指令的原理
### 整体总结
```
转移行为:
    (1) 只修改IP, 称为段内转移, 比如jmp ax
    (2) 同时修改CS和IP时, 称为段间转移, 比如 jmp 1000:0  (这个如果通过汇编代码这样写会报错, 如果在debug中写入这个代码则不会)

转移指令对IP的修改范围不同, 段内转移又分为: 短转移和近转移
    短转移IP的修改范围为-128 ~ 127
    近转移IP的修改范围为-32768 ~ 32767

转移指令分为以下几类:
    - 无条件转移指令(如: jmp)
    - 条件转移指令(如 jcxz)
    - 循环制冷(如果: loop)
    - 过程
    - 中断
```

### 汇编标号offset的作用
```
如果标号在当前段内: offset获取的是标号在段内的偏移地址, 这个时候有没有offset都是一样的
如果标号对应的是段地址: offset表示段的大小

assume cs:code

data segment
	db 'welcome to masm!'
	db 2h, 24h, 1h
data ends

code segment
start:	
s:	mov ax, 1
	mov ax, 2
	mov ax, 3
	mov bx, offset data ;data段的大小, 这里是0013H
	mov bx, offset s    ;s标号在code段的偏移地址, 这里是0

	mov ax, 4c00h
	int 21h
code ends
end start
```

### jmp指令描述
```
jmp指令要提供两种信息
    (1) 转移的目的地址
    (2) 转移的距离(段间转移、段内短转移、段内近转移)

jmp short 标号: 段内短转移, 转到标号处执行指令, 对IP的修改范围为-128~127, 如果超过这个值编译会报错 
                (标号处的地址 - jmp指令后的第一个字节的地址)需要是8位位移, 补码表示
jmp near ptr 标号: 段内近转移, 转到标号处执行指令, 对IP的修改范围为-32768~32767, 如果超过这个值编译会报错
                (标号处的地址 - jmp指令后的第一个字节的地址)需要是16位位移, 补码表示
jmp far ptr 标号: 段间转移, 远转移, 用标号的段地址和偏移地址修改CS和IP

jmp 16位寄存器: 段内偏移, 修改IP为寄存器的值

jmp word ptr 内存单元地址(段内偏移, 因为word是16个字节)
    mov ax, 0123h
    mov ds:[0], ax
    jmp word ptr ds:[0] ---> IP变为0123H

jmp dword ptr 内存单元地址(段间转移, 因为dword是两个字, 超过了16个字节, 高地址处为目的段地址, 低地址处为目的偏移地址)
    mov ax, 0123h
    mov ds:[0], ax
    mov word ptr ds:[2], 0
    jmp dword ptr ds:[0] ---> CS变0, IP变为0123
```

### jmp指令原理
```
assume cs:code

code segment
start:	
s:	mov ax, 0
    jmp short s
    add ax, 1
s:  inc ax


	mov ax, 4c00h
	int 21h
code ends
end start

上述指令的机器码表示形式为:
    0BBD:0000   B80000  MOV AX,0000
    0BBD:0003   EB03    JMP 0008
    0BBD:0005   ADD     AX,0001
    0BBD:0008   40      INC AX

最左边一列尾内存地址, 中间一列为机器码表示的汇编指令, 最右边一列为汇编指令, 对于JMP指令来说, 汇编指令已经将其表示
为跳转到内存地址为0008位置, 但是表现为机器码的时候却是EB03, EB表示是的JMP指令, 03表示的是偏移地址, 原因是当将
JMP指令加载到指令缓冲器后, IP转向下一条指令地址, 即ADD AX, 0001   执行JMP指令的时候, 根据此时IP和目标地址进行计算,
得到偏移地址为0008 - 0005 = 03, 所以表示为EB03 ------ 以上是段内偏移(短偏移 + 近偏移)的原理

对于段间偏移来说, 则EA(不是EB)后面跟着的是段地址和偏移地址
```

### jcxz命令
```
jcxz: 有条件转移指令, 所有的有条件转移指令都是短转移, IP的修改范围都是-128~127
指令格式:  jcxz 标号
执行流程
    (1) 当cx = 0时, IP = IP + 8位位移, 即当cx等于0的时候, 跳转到标号所在的地址, 标号与该命令的地址范围不能超过限定值
    (2) 位移计算: 8位位移 = 标号处的地址 - jcxz指令后的第一个字节的地址
    (3) 位移由编译程序在编译时算出
    (4) 当cx 不为0 的时候, 什么也不做, 执行下一条命令

相当于:
    if (cx == 0) {
        jmp short 标号
    }
```

### loop命令
```
loop: 循环指令, 所有的有条件转移指令都是短转移, IP的修改范围都是-128~127
指令格式: loop 标号    
执行流程:
    (1) cx = cx - 1
    (2) 如果cx 不为0, 则跳转到标号所在地址(8位位移)
    (3) 如果cx 为0, 则什么也不做, 继续向下执行

相当于:
    cx = cx - 1;
    if ( cx != 0 ) {
        jmp short 标号
    }
```
